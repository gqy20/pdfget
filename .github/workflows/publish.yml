name: Publish Python Package

on:
  push:
    tags:
      - 'v*'

jobs:
  test-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install uv
      uses: astral-sh/setup-uv@v2

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run tests
      run: |
        uv run pytest tests/ -v

    - name: Run code quality checks
      run: |
        uv run ruff check .
        uv run ruff format --check .

    - name: Build package
      run: |
        uv build

    - name: Show package info
      run: |
        find dist/ -name "*.whl" -exec python -m pip show {} \; || true
        find dist/ -name "*.tar.gz" -exec python -m pip show {} \; || true
        ls -la dist/

    - name: Publish to PyPI
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        uv publish --token $PYPI_API_TOKEN

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        body: |
          ğŸ‰ PDFGet ${{ github.ref }} å·²å‘å¸ƒï¼

          ## ğŸ“¦ å®‰è£…æ–¹æ³•
          ```bash
          pip install pdfget
          # æˆ–ä½¿ç”¨uv
          uv add pdfget
          ```

          ## ğŸš€ ä½¿ç”¨ç¤ºä¾‹
          ```bash
          # æœç´¢å¹¶ä¸‹è½½æ–‡çŒ®
          pdfget -s "machine learning" -l 20 -d -t 5

          # é«˜çº§æ£€ç´¢
          pdfget -s "cancer AND immunotherapy NOT review" -l 30

          # æ‰¹é‡ä¸‹è½½
          pdfget -i dois.csv -d -t 3
          ```

          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/gqy20/pdfget/blob/main/CHANGELOG.md)
